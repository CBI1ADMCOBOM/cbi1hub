<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAIA - Nova Ocorrência</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Ícones -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        .radio-buttons-container {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }

        .radio-button-label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid #e2e8f0;
            background: #fff;
            transition: all 0.2s;
            flex: 1;
            font-weight: 600;
            color: #64748b;
        }

        .radio-button-label:hover {
            border-color: #cbd5e1;
            background: #f8fafc;
        }

        .radio-button-input {
            display: none;
        }

        /* Estilo quando "Sim" (Verde) está marcado */
        .radio-button-input[value="YES"]:checked+.radio-button-label {
            border-color: #22c55e;
            background: #dcfce7;
            color: #166534;
        }

        /* Estilo quando "Não" (Vermelho) está marcado */
        .radio-button-input[value="NO"]:checked+.radio-button-label {
            border-color: #ef4444;
            background: #fee2e2;
            color: #991b1b;
        }
    </style>
</head>

<body>
    <div class="app-container">
        <header class="app-header">
            <div class="header-content">
                <div class="logo">BOMBEIROS CBI-1 <span style="font-weight: 400; font-size: 0.9em; opacity: 0.8;">|
                        Elaborar RAIA</span></div>
                <div class="user-menu">
                    <a href="{{ url_for('dashboard') }}" class="btn-secondary btn-sm" style="margin-right: 10px;">Voltar
                        ao Menu</a>
                    <span>{{ user.email }}</span>
                    <a href="{{ url_for('logout') }}" class="btn-logout"><i class="bi bi-box-arrow-right"></i> Sair</a>
                </div>
            </div>
        </header>

        <main class="app-content">
            <div class="card">
                <div class="card-header">
                    <h2>Nova Ocorrência</h2>
                    <p>Preencha os dados abaixo para registrar um incidente.</p>
                </div>

                <form id="occurrence-form">
                    <!-- Unidade -->
                    <div class="section-title">Unidade de Atendimento</div>
                    <div class="form-group">
                        <label for="opm_id">Área de atendimento da EB:</label>
                        <select id="opm_id" name="opm_id" required>
                            <option value="">Carregando estações...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="concessionaire_id">Concessionária:</label>
                        <select id="concessionaire_id" name="concessionaire_id" required>
                            <option value="">Carregando concessionárias...</option>
                        </select>
                    </div>

                    <!-- Localização -->
                    <div class="section-title">Localização</div>



                    <div class="form-group">
                        <label>Endereço ou Coordenada</label>
                        <div class="geo-input" style="display: flex; gap: 8px;">
                            <input type="text" id="location_text" name="location_text"
                                placeholder="Digite o endereço/coordenada ou use o GPS" required style="flex: 1;">
                            <button type="button" id="btn-geo" class="btn-secondary"
                                style="white-space: nowrap; background-color: #f57c00; border-color: #f57c00; color: white;"><i
                                    class="bi bi-geo-alt-fill"></i> Usar Minha Localização</button>
                        </div>
                        <!-- Campos ocultos para armazenar coordenadas precisas se o GPS for usado -->
                        <input type="hidden" id="latitude" name="latitude">
                        <input type="hidden" id="longitude" name="longitude">
                    </div>

                    <!-- Detalhes -->
                    <div class="section-title">Detalhes do Incidente</div>
                    <div class="form-group">
                        <label for="nature">Natureza da Ocorrência</label>
                        <select id="nature" name="nature" required>
                            <option value="">Carregando naturezas...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="description">Descrição / Observações</label>
                        <textarea id="description" name="description" rows="3"
                            placeholder="Descreva detalhes adicionais..."></textarea>
                    </div>

                    <!-- Responsável -->
                    <div class="section-title">Responsável no Local</div>
                    <div class="form-group">
                        <div class="radio-buttons-container">
                            <!-- Opção NÃO -->
                            <input type="radio" id="resp_no" name="has_responsible" value="NO"
                                class="radio-button-input" checked onchange="toggleResponsibleFields()">
                            <label for="resp_no" class="radio-button-label">
                                <i class="bi bi-person-x-fill"></i>
                                Sem Responsável
                            </label>

                            <!-- Opção SIM -->
                            <input type="radio" id="resp_yes" name="has_responsible" value="YES"
                                class="radio-button-input" onchange="toggleResponsibleFields()">
                            <label for="resp_yes" class="radio-button-label">
                                <i class="bi bi-person-check-fill"></i>
                                Tem Responsável
                            </label>
                        </div>
                    </div>

                    <div id="responsible-details">
                        <div class="form-group">
                            <label for="resp_name">Nome</label>
                            <input type="text" id="resp_name" name="resp_name" placeholder="Nome do responsável">
                        </div>
                        <div class="form-group">
                            <label for="resp_role">Função / Cargo</label>
                            <input type="text" id="resp_role" name="resp_role"
                                placeholder="Ex: Inspetor, Gerente, Motorista">
                        </div>
                        <div class="form-group">
                            <label for="resp_contact">Contato</label>
                            <input type="tel" id="resp_contact" name="resp_contact" placeholder="(XX) XXXXX-XXXX">
                        </div>
                    </div>

                    <!-- Mídia -->
                    <div class="section-title">Fotos</div>
                    <div class="form-group">
                        <div class="file-upload-container">
                            <label for="photos" class="btn-secondary"><i class="bi bi-camera"></i> Adicionar Fotos
                                (Obrigatório)</label>
                            <input type="file" id="photos" name="photos" multiple accept="image/*"
                                style="display: none;">
                            <div id="photo-preview-container" class="photo-grid"
                                style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 10px;"></div>
                        </div>
                        <!-- Input oculto para manter a referência dos arquivos válidos (simulado via DataTransfer no submit) -->
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn-primary">Registrar Ocorrência</button>
                    </div>
                </form>
            </div>
        </main>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Carregar OPMs (Estações)
            fetch('/api/opms')
                .then(r => r.json())
                .then(data => {
                    const select = document.getElementById('opm_id');
                    select.innerHTML = '<option value="">Selecione a Estação...</option>';
                    data.forEach(opm => {
                        const option = document.createElement('option');
                        option.value = opm.id;
                        option.textContent = `${opm.EB} (${opm.GB})`;
                        select.appendChild(option);
                    });
                })
                .catch(err => {
                    console.error('Erro ao carregar OPMs:', err);
                    document.getElementById('opm_id').innerHTML = '<option value="">Erro ao carregar</option>';
                });

            // Carregar Naturezas RAIA
            fetch('/api/naturezas_raia')
                .then(r => r.json())
                .then(data => {
                    const select = document.getElementById('nature');
                    select.innerHTML = '<option value="">Selecione...</option>';
                    data.forEach(nat => {
                        const option = document.createElement('option');
                        option.value = nat.code; // Usando o código como valor
                        option.textContent = nat.code;
                        select.appendChild(option);
                    });
                })
                .catch(err => {
                    console.error('Erro ao carregar naturezas:', err);
                    document.getElementById('nature').innerHTML = '<option value="">Erro ao carregar</option>';
                });

            // Carregar Concessionárias
            fetch('/api/concessionarias')
                .then(r => r.json())
                .then(data => {
                    const select = document.getElementById('concessionaire_id');
                    select.innerHTML = '<option value="">Selecione...</option>';
                    data.forEach(css => {
                        const option = document.createElement('option');
                        option.value = css.id;
                        option.textContent = css.name;
                        select.appendChild(option);
                    });
                })
                .catch(err => {
                    console.error('Erro ao carregar concessionárias:', err);
                    document.getElementById('concessionaire_id').innerHTML = '<option value="">Erro ao carregar</option>';
                });
        });
        // Lógica do GPS
        document.getElementById('btn-geo').addEventListener('click', () => {
            const btn = document.getElementById('btn-geo');
            const input = document.getElementById('location_text');
            const latInput = document.getElementById('latitude');
            const longInput = document.getElementById('longitude');

            if (!navigator.geolocation) {
                alert('Geolocalização não suportada pelo seu navegador.');
                return;
            }

            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Obtendo...';
            btn.disabled = true;

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const long = position.coords.longitude;

                    // Preenche os campos ocultos
                    latInput.value = lat;
                    longInput.value = long;

                    // Preenche o campo visível
                    input.value = `${lat}, ${long}`;

                    btn.innerHTML = '<i class="bi bi-check-lg"></i> Sucesso';
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }, 2000);
                },
                (error) => {
                    console.error(error);
                    alert('Erro ao obter localização. Verifique se o GPS está ativo e se você permitiu o acesso.');
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                },
                { enableHighAccuracy: true }
            );
        });

        // Lógica do Responsável
        function toggleResponsibleFields() {
            const hasResponsible = document.querySelector('input[name="has_responsible"]:checked').value === 'YES';
            const detailsDiv = document.getElementById('responsible-details');
            const inputs = detailsDiv.querySelectorAll('input');

            if (hasResponsible) {
                detailsDiv.style.display = 'block';
                inputs.forEach(input => input.required = true);
            } else {
                detailsDiv.style.display = 'none';
                inputs.forEach(input => {
                    input.required = false;
                    input.value = ''; // Limpa os campos
                });
            }
        }

        // Inicializar estado correto
        document.addEventListener('DOMContentLoaded', () => {
            toggleResponsibleFields();
        });
        // Gerenciamento de Fotos
        let selectedFiles = []; // Array para armazenar os arquivos selecionados

        document.getElementById('photos').addEventListener('change', (e) => {
            const files = Array.from(e.target.files);

            files.forEach(file => {
                // Adiciona ao array se ainda não estiver (opcional: verificar duplicatas por nome/tamanho)
                selectedFiles.push(file);

                // Cria elemento visual
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const div = document.createElement('div');
                    div.className = 'photo-item';
                    div.style.position = 'relative';
                    div.style.width = '100px';
                    div.style.height = '100px';
                    div.style.border = '1px solid #ddd';
                    div.style.borderRadius = '4px';
                    div.style.overflow = 'hidden';

                    div.innerHTML = `
                        <img src="${ev.target.result}" style="width: 100%; height: 100%; object-fit: cover;">
                        <button type="button" class="btn-remove-photo" style="position: absolute; top: 2px; right: 2px; background: red; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; cursor: pointer;">&times;</button>
                    `;

                    // Botão de remover
                    div.querySelector('.btn-remove-photo').addEventListener('click', () => {
                        // Remove do array
                        const index = selectedFiles.indexOf(file);
                        if (index > -1) {
                            selectedFiles.splice(index, 1);
                        }
                        // Remove do DOM
                        div.remove();
                    });

                    document.getElementById('photo-preview-container').appendChild(div);
                };
                reader.readAsDataURL(file);
            });

            // Limpa o input original para permitir selecionar os mesmos arquivos novamente se quiser adicionar mais
            e.target.value = '';
        });

        // Validação e Envio do Formulário
        document.getElementById('occurrence-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (selectedFiles.length === 0) {
                alert('Por favor, adicione pelo menos uma foto da ocorrência.');
                return;
            }

            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.textContent;
            btn.textContent = 'Enviando...';
            btn.disabled = true;

            const formData = new FormData(e.target);

            // Remove o campo 'photos' original vazio do FormData e adiciona os arquivos do array
            formData.delete('photos');
            selectedFiles.forEach(file => {
                formData.append('photos', file);
            });

            try {
                const response = await fetch('/api/raia/save', {
                    method: 'POST',
                    body: formData // Fetch envia multipart/form-data automaticamente
                });

                const result = await response.json();

                if (result.success) {
                    alert('Ocorrência registrada com sucesso! \n\nVocê pode visualizá-la no menu "VISUALIZAR", localizado ao lado da opção de gerar.');
                    window.location.href = '/elaborar-raia'; // Redireciona para o menu RAIA
                } else {
                    alert('Erro ao salvar: ' + (result.error || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error(error);
                alert('Erro de conexão ao salvar ocorrência.');
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        });
    </script>
    <script src="{{ url_for('static', filename='script.js') }}"></script>
</body>

</html>
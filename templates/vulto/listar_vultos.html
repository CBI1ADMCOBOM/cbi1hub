<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VULTO - Minhas Ocorrências</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        .vulto-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            padding: 20px;
            border-left: 5px solid #dc2626;
            /* Vermelho Bombeiros */
        }

        .vulto-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .vulto-natureza {
            font-size: 1.1em;
            font-weight: 700;
            color: #1f2937;
        }

        .vulto-data {
            color: #6b7280;
            font-size: 0.9em;
        }

        .vulto-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
            font-size: 0.95em;
        }

        .detail-item strong {
            display: block;
            color: #4b5563;
            font-size: 0.85em;
            margin-bottom: 2px;
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-aberto {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Em andamento */
        .status-encerrado {
            background: #dcfce7;
            color: #166534;
        }

        .btn-copy {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
        }

        .btn-copy:hover {
            background: #e5e7eb;
        }
    </style>
</head>

<body>
    <div class="app-container">
        <header class="app-header">
            <div class="header-content">
                <div class="logo">BOMBEIROS CBI-1 <span style="font-weight: 400; font-size: 0.9em; opacity: 0.8;">|
                        Histórico de Vultos</span></div>
                <div class="user-menu">
                    <a href="{{ url_for('elaborar_vulto') }}" class="btn-secondary btn-sm"
                        style="margin-right: 10px;">Voltar</a>
                    <span>{{ user.email }}</span>
                    <a href="{{ url_for('logout') }}" class="btn-logout"><i class="bi bi-box-arrow-right"></i> Sair</a>
                </div>
            </div>
        </header>

        <main class="app-content">
            <div class="card">
                <div class="card-header">
                    <h2>Meus Registros de Vulto</h2>
                    <p>Histórico das ocorrências de destaque geradas por você.</p>
                </div>

                <div id="loading" style="text-align: center; padding: 40px;">
                    <span class="spinner-border spinner-border-lg"></span>
                    <p style="margin-top: 10px; color: #6b7280;">Carregando ocorrências...</p>
                </div>

                <div id="lista-vultos" style="display: none;">
                    <!-- Preenchido via JS -->
                </div>

                <div id="empty-state" style="display: none; text-align: center; padding: 40px; color: #6b7280;">
                    <i class="bi bi-clipboard-x" style="font-size: 3em; color: #d1d5db;"></i>
                    <p style="margin-top: 15px;">Nenhuma ocorrência de vulto registrada.</p>
                    <a href="{{ url_for('elaborar_vulto_novo') }}" style="color: #dc2626; font-weight: 500;">Criar nova
                        agora</a>
                </div>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            fetch('/api/vulto/me')
                .then(r => r.json())
                .then(data => {
                    document.getElementById('loading').style.display = 'none';
                    const container = document.getElementById('lista-vultos');

                    if (data.length === 0) {
                        document.getElementById('empty-state').style.display = 'block';
                        return;
                    }

                    container.style.display = 'block';
                    data.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'vulto-card';

                        // Status Badge
                        const statusClass = item.status === 'ENCERRADA' ? 'status-encerrado' : 'status-aberto';

                        // Formatar data
                        const dataFormatada = item.data_inicio ? item.data_inicio.split('-').reverse().join('/') : '-';

                        div.innerHTML = `
                            <div class="vulto-header">
                                <div class="vulto-natureza">
                                    <span class="status-badge ${statusClass}">${item.status || 'N/A'}</span>
                                    ${item.natureza_codigo || 'Sem Natureza'} <span style="font-weight:400; font-size:0.9em; color:#6b7280;">(Talão: ${item.talao_numero})</span>
                                </div>
                                <div class="vulto-data">
                                    <i class="bi bi-calendar"></i> ${dataFormatada} ${item.hora_inicio || ''}
                                </div>
                            </div>
                            
                            <div class="vulto-details">
                                <div class="detail-item">
                                    <strong>MUNICÍPIO</strong>
                                    ${item.municipio_nome}
                                </div>
                                <div class="detail-item">
                                    <strong>JUSTIFICATIVA</strong>
                                    ${item.justificativa_vulto}
                                </div>
                                <div class="detail-item">
                                    <strong>ENCARREGADO</strong>
                                    ${item.encarregado_posto} ${item.encarregado_nome}
                                </div>
                                <div class="detail-item">
                                    <strong>RECURSOS</strong>
                                    ${item.qtd_viaturas} VTRs, ${item.qtd_bombeiros} Militares
                                </div>
                            </div>
                            
                            <div style="background: #f9fafb; padding: 15px; border-radius: 6px; border: 1px dashed #e5e7eb; margin-top: 10px;">
                                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                                    <span style="font-size:0.85em; font-weight:600; color:#374151; text-transform:uppercase;">Texto Gerado</span>
                                    <button class="btn-copy" onclick="copiarTexto('${btoa(item.generated_text || '')}')">
                                        <i class="bi bi-clipboard"></i> Copiar
                                    </button>
                                </div>
                                <div style="font-family:monospace; font-size:0.85em; color:#4b5563; white-space: pre-wrap; max-height: 100px; overflow-y: auto;">${item.generated_text || 'Sem texto gerado.'}</div>
                            </div>
                        `;
                        container.appendChild(div);
                    });
                })
                .catch(err => {
                    console.error(err);
                    document.getElementById('loading').innerHTML = '<p class="text-danger">Erro ao carregar dados.</p>';
                });
        });

        function copiarTexto(base64Text) {
            try {
                const text = atob(base64Text);
                navigator.clipboard.writeText(text).then(() => {
                    alert('Texto copiado para a área de transferência!');
                });
            } catch (e) {
                alert('Erro ao copiar.');
            }
        }
    </script>
</body>

</html>
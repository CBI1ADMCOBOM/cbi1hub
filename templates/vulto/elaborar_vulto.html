<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VULTO - Nova Ocorrência</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        .radio-buttons-container {
            display: flex;
            gap: 15px;
            margin-top: 5px;
            width: 100%;
        }

        .radio-button-label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            border: 1px solid #e2e8f0;
            background: #f8fafc;
            color: #64748b;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            flex: 1;
            font-weight: 600;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .radio-button-label:hover {
            background: #f1f5f9;
            transform: translateY(-1px);
        }

        .radio-button-input {
            display: none;
        }

        /* ESTILOS SÓLIDOS (PREMIUM) QUANDO SELECIONADO */

        /* EM ATENDIMENTO (Azul Sólido) */
        .radio-button-input[value="EM ATENDIMENTO"]:checked+.radio-button-label {
            background-color: #3b82f6;
            border-color: #3b82f6;
            color: white;
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3);
        }

        /* ENCERRADA / SIM (Verde Sólido) */
        .radio-button-input[value="ENCERRADA"]:checked+.radio-button-label,
        .radio-button-input[value="sim"]:checked+.radio-button-label {
            background-color: #22c55e;
            border-color: #22c55e;
            color: white;
            box-shadow: 0 4px 6px -1px rgba(34, 197, 94, 0.3);
        }

        /* NÃO (Vermelho Sólido) */
        .radio-button-input[value="nao"]:checked+.radio-button-label {
            background-color: #ef4444;
            border-color: #ef4444;
            color: white;
            box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.3);
        }

        /* Ícones dentro do label */
        .radio-button-label i {
            font-size: 1.1em;
        }

        /* Novo Padrão de Título (Section Header) */
        .section-header {
            margin-bottom: 20px;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 10px;
            font-weight: 600;
            color: #dc2626;
            /* Cor Primária Vermelha */
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1em;
            margin-top: 30px;
        }

        .section-header i {
            font-size: 1.2em;
        }

        /* Animação Botão IA */
        @keyframes gradient-xy {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        @keyframes pulse-ring {
            0% {
                box-shadow: 0 0 0 0 rgba(168, 85, 247, 0.7);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(168, 85, 247, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(168, 85, 247, 0);
            }
        }

        .btn-ai-feature {
            background: linear-gradient(45deg, #4f46e5, #9333ea, #c026d3, #4f46e5);
            background-size: 300% 300%;
            animation: gradient-xy 4s ease infinite, pulse-ring 2s infinite;
            border: none;
            color: white;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            position: relative;
            z-index: 1;
            overflow: hidden;
            transition: transform 0.2s;
        }

        .btn-ai-feature:hover {
            transform: scale(1.02);
            filter: brightness(1.1);
        }
    </style>
</head>

<body>
    <div class="app-container">
        <header class="app-header">
            <div class="header-content">
                <div class="logo">
                    <img src="{{ url_for('static', filename='img/brasao_bombeiros.png') }}" alt="Brasão Bombeiros"
                        style="height: 40px; width: auto;">
                    <span>BOMBEIROS CBI-1 <span style="font-weight: 400; font-size: 0.9em; opacity: 0.8;">|
                            Vulto</span></span>
                </div>
                <div class="user-menu" style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 0.9rem; color: #e5e7eb; margin-right: 10px;">{{ user.war_name }}</span>
                    <a href="{{ url_for('vulto.elaborar_vulto_listar') }}" class="header-icon-btn">
                        <i class="bi bi-list-ul"></i> Visualizar
                    </a>
                    <a href="{{ url_for('main.dashboard') }}" class="header-icon-btn">
                        <i class="bi bi-house-door-fill"></i> Início
                    </a>
                    <a href="{{ url_for('auth.logout') }}" class="header-icon-btn">
                        <i class="bi bi-box-arrow-right"></i> Sair
                    </a>
                </div>
            </div>
        </header>

        <main class="app-content">
            <div class="card">
                <div class="card-header">
                    <h2>Nova Ocorrência de Vulto</h2>
                    <p>Preencha os dados abaixo para gerar o comunicado de destaque.</p>
                </div>

                <form id="vulto-form">
                    <!-- Unidade e Dados Básicos -->
                    <!-- Unidade e Dados Básicos -->
                    <div class="section-header"><i class="bi bi-info-circle"></i> Dados Iniciais</div>
                    <div class="form-row" style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <div class="form-group" style="flex: 1; min-width: 250px;">
                            <label for="opm_id">Unidade de Atendimento:</label>
                            <select id="opm_id" name="opm_id" required>
                                <option value="">Carregando estações...</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 1; min-width: 150px;">
                            <label for="talao_numero">A. Nº Talão:</label>
                            <input type="text" id="talao_numero" name="talao_numero" required>
                        </div>
                    </div>

                    <div class="form-row" style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <div class="form-group" style="flex: 1;">
                            <label for="data_inicio">B. Data Início:</label>
                            <input type="date" id="data_inicio" name="data_inicio" required>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label for="hora_inicio">B. Hora Início:</label>
                            <input type="time" id="hora_inicio" name="hora_inicio" required>
                        </div>
                        <div class="form-group" style="flex: 1; min-width: 300px;">
                            <label>C. Status:</label>
                            <div class="radio-buttons-container">
                                <input type="radio" id="status_atendimento" name="status" value="EM ATENDIMENTO"
                                    class="radio-button-input" checked onchange="toggleTermino()">
                                <label for="status_atendimento" class="radio-button-label">
                                    <i class="bi bi-hourglass-split"></i> Em Atendimento
                                </label>

                                <input type="radio" id="status_encerrada" name="status" value="ENCERRADA"
                                    class="radio-button-input" onchange="toggleTermino()">
                                <label for="status_encerrada" class="radio-button-label">
                                    <i class="bi bi-check-circle-fill"></i> Encerrada
                                </label>
                            </div>
                        </div>
                    </div>

                    <div id="termino-group" class="form-row"
                        style="display: none; gap: 15px; flex-wrap: wrap; background: #f8fafc; padding: 10px; border-radius: 8px; margin-bottom: 15px;">
                        <div class="form-group" style="flex: 1;">
                            <label for="data_termino">Data Término:</label>
                            <input type="date" id="data_termino" name="data_termino">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label for="hora_termino">Hora Término:</label>
                            <input type="time" id="hora_termino" name="hora_termino">
                        </div>
                    </div>

                    <!-- Classificação -->
                    <!-- Classificação -->
                    <div class="section-header"><i class="bi bi-exclamation-triangle"></i> Classificação</div>
                    <div class="form-group">
                        <label for="justificativa_vulto">D. Justificativa (Tipo de Destaque):</label>
                        <select id="justificativa_vulto" name="justificativa_vulto" required>
                            <option value="">Selecione a Justificativa</option>
                            <option value="5 VÍTIMAS OU MAIS (SOCORRIDAS OU FATAIS)">5 Vítimas ou mais (Socorridas ou
                                Fatais)</option>
                            <option value="ENVOLVENDO INSTITUIÇÃO PÚBLICA">Envolvendo Instituição Pública (Poderes,
                                Delegacias, Escolas, Hospitais, etc)</option>
                            <option value="ENVOLVENDO INSTITUIÇÃO FINANCEIRA">Envolvendo Instituição Financeira
                                (Atentado Explosivo / Incêndio)</option>
                            <option value="ENVOLVENDO MEIO DE TRANSPORTE">Envolvendo meio de transporte (Aeronáutico,
                                Ferroviário, Coletivo, etc)</option>
                            <option value="TÍPICAS DE OPERAÇÕES SAZONAIS">Típicas de operações sazonais (Verão ou Corta
                                Fogo)</option>
                            <option value="MAIS DE 10 VIATURAS NO CBM E 7 NO CBI">Mais de 10 viaturas no CBM e 7 no CBI
                            </option>
                            <option value="ENVOLVENDO MAIS DE UM GB DO CBI">Envolvendo mais de um GB do CBI</option>
                            <option value="ENVOLVENDO AUTORIDADE OU PERSONALIDADE">Envolvendo Autoridade ou
                                Personalidade (Poderes ou Soc. Civil)</option>
                            <option value="ENVOLVENDO INTEGRANTES DA PMESP">Envolvendo Integrantes da PMESP</option>
                            <option value="ENVOLVENDO OFICIAIS SUPERIORES DA PMESP">Envolvendo Oficiais Superiores da
                                PMESP (Inclusive Inativos)</option>
                            <option value="ENVOLVENDO VIATURA DO CB">Envolvendo viatura do CB (Acidente de Trânsito)
                            </option>
                            <option value="ENVOLVENDO PRODUTOS PERIGOSOS">Envolvendo Produtos Perigosos (3 VTRs ou +,
                                Oficial CB e/ou Órgãos de Apoio)</option>
                            <option value="INTERDIÇÃO DE VIA POR MAIS DE 1H">Interdição de via urbana importante ou
                                rodovia por mais de 1h</option>
                            <option value="MORTE DE POLICIAL MILITAR EM SERVIÇO OU FOLGA">Morte de Policial Militar em
                                serviço ou folga</option>
                            <option value="MORTE DE POLICIAL CIVIL EM SERVIÇO">Morte de Policial Civil em Serviço
                            </option>
                            <option value="MDIP/LCDIP (CONFRONTO)">MDIP/LCDIP (Confronto) com atuação do CB</option>
                            <option value="REPERCUSSÃO NA MÍDIA">Repercussão na mídia (Múltiplos canais)</option>
                            <option value="INCÊNDIO COM VÍTIMA FATAL">Incêndio com vítima fatal</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="natureza_codigo">E. Natureza da Ocorrência:</label>
                        <select id="natureza_codigo" name="natureza_codigo" required>
                            <option value="null">Selecione a natureza</option>
                            <option value="A05 - AGRESSÃO">A05 - AGRESSÃO</option>
                            <option value="A22 - SUICÍDIO ARMA DE FOGO">A22 - SUICÍDIO ARMA DE FOGO</option>
                            <option value="A23 - TENTATIVA DE SUICÍDIO">A23 - TENTATIVA DE SUICÍDIO</option>
                            <option value="A24 - AFOGAMENTO EM CURSO">A24 - AFOGAMENTO EM CURSO</option>
                            <option value="E07 - APOIO">E07 - APOIO</option>
                            <option value="L06 - INTERDIÇÃO DE VIA PÚBLICA">L06 - INTERDIÇÃO DE VIA PÚBLICA</option>
                            <option value="L07 - ATROPELAMENTO">L07 - ATROPELAMENTO</option>
                            <option value="L08 - ACIDENTE DE TRÂNSITO COM VÍTIMA">L08 - ACIDENTE DE TRÂNSITO COM VÍTIMA
                            </option>
                            <option value="L09 - ACIDENTE DE TRÂNSITO SEM VÍTIMA">L09 - ACIDENTE DE TRÂNSITO SEM VÍTIMA
                            </option>
                            <option value="L10 - ACIDENTE DE TRÂNSITO COM PM">L10 - ACIDENTE DE TRÂNSITO COM PM</option>
                            <option value="L28 - ACIDENTE DE TRÂNSITO COM VÍTIMA PRESA">L28 - ACIDENTE DE TRÂNSITO COM
                                VÍTIMA PRESA</option>
                            <option value="M01 - OCORRÊNCIA COM PESSOA">M01 - OCORRÊNCIA COM PESSOA</option>
                            <option value="M10 - DESMORONAMENTO">M10 - DESMORONAMENTO</option>
                            <option value="M15 - QUEDA DE PESSOA">M15 - QUEDA DE PESSOA</option>
                            <option value="M16 - ACIDENTE PESSOAL">M16 - ACIDENTE PESSOAL</option>
                            <option value="M22 - EMERGÊNCIA CLÍNICA">M22 - EMERGÊNCIA CLÍNICA</option>
                            <option value="N01 - INCÊNDIO">N01 - INCÊNDIO</option>
                            <option value="N02 - EXPLOSÃO">N02 - EXPLOSÃO</option>
                            <option value="N04 - VAZAMENTO/ PRODUTOS PERIGOSOS">N04 - VAZAMENTO/ PRODUTOS PERIGOSOS
                            </option>
                            <option value="N06 - OCORRÊNCIA COM ÁRVORE">N06 - OCORRÊNCIA COM ÁRVORE</option>
                            <option value="N08 - ACIDENTE COM MEIO DE TRANSPORTE">N08 - ACIDENTE COM MEIO DE TRANSPORTE
                            </option>
                            <option value="N10 - DESABAMENTO/DESMORONAMENTO/SOTERRAMENTO">N10 -
                                DESABAMENTO/DESMORONAMENTO/SOTERRAMENTO</option>
                            <option value="N11 - DESABAMENTOS">N11 - DESABAMENTOS</option>
                            <option value="N13 - OCORRÊNCIA COM OBJETO">N13 - OCORRÊNCIA COM OBJETO</option>
                            <option value="N14 - INUNDAÇÃO/ENCHENTE">N14 - INUNDAÇÃO/ENCHENTE</option>
                            <option value="N15 - QUEDA">N15 - QUEDA</option>
                            <option value="N16 - EMBARCAÇÃO EM SITUAÇÃO DE RISCO">N16 - EMBARCAÇÃO EM SITUAÇÃO DE RISCO
                            </option>
                            <option value="N24 - VAZAMENTO DE GLP">N24 - VAZAMENTO DE GLP</option>
                            <option value="N28 - OCORRÊNCIA COM ANIMAL">N28 - OCORRÊNCIA COM ANIMAL</option>
                            <option value="N30 - ATIVIDADE EDUCATIVA DE BOMBEIRO">N30 - ATIVIDADE EDUCATIVA DE BOMBEIRO
                            </option>
                            <option value="N99 - INCÊNDIO EM VEGETAÇÃO">N99 - INCÊNDIO EM VEGETAÇÃO</option>
                        </select>

                    </div>

                    <!-- Localização -->
                    <!-- Localização -->
                    <div class="section-header"><i class="bi bi-geo-alt-fill"></i> Localização</div>
                    <div class="form-group">
                        <label for="municipio_nome">F. Município:</label>
                        <select id="municipio_nome" name="municipio_nome" required>
                            <option value="">Selecione o Município</option>
                            <option value="Aguaí">Aguaí</option>
                            <option value="Águas da Prata">Águas da Prata</option>
                            <option value="Águas de Lindóia">Águas de Lindóia</option>
                            <option value="Águas de Santa Bárbara">Águas de Santa Bárbara</option>
                            <option value="Águas de São Pedro">Águas de São Pedro</option>
                            <option value="Alambari">Alambari</option>
                            <option value="Alumínio">Alumínio</option>
                            <option value="Americana">Americana</option>
                            <option value="Amparo">Amparo</option>
                            <option value="Analândia">Analândia</option>
                            <option value="Angatuba">Angatuba</option>
                            <option value="Anhembi">Anhembi</option>
                            <option value="Apiaí">Apiaí</option>
                            <option value="Araçariguama">Araçariguama</option>
                            <option value="Araçoiaba da Serra">Araçoiaba da Serra</option>
                            <option value="Arandu">Arandu</option>
                            <option value="Araras">Araras</option>
                            <option value="Areiópolis">Areiópolis</option>
                            <option value="Artur Nogueira">Artur Nogueira</option>
                            <option value="Atibaia">Atibaia</option>
                            <option value="Avaré">Avaré</option>
                            <option value="Barão de Antonina">Barão de Antonina</option>
                            <option value="Barra do Chapéu">Barra do Chapéu</option>
                            <option value="Bofete">Bofete</option>
                            <option value="Boituva">Boituva</option>
                            <option value="Bom Jesus dos Perdões">Bom Jesus dos Perdões</option>
                            <option value="Bom Sucesso de Itararé">Bom Sucesso de Itararé</option>
                            <option value="Botucatu">Botucatu</option>
                            <option value="Bragança Paulista">Bragança Paulista</option>
                            <option value="Brotas">Brotas</option>
                            <option value="Buri">Buri</option>
                            <option value="Cabreúva">Cabreúva</option>
                            <option value="Caconde">Caconde</option>
                            <option value="Campina do Monte Alegre">Campina do Monte Alegre</option>
                            <option value="Campinas">Campinas</option>
                            <option value="Campo Limpo Paulista">Campo Limpo Paulista</option>
                            <option value="Capão Bonito">Capão Bonito</option>
                            <option value="Capela do Alto">Capela do Alto</option>
                            <option value="Capivari">Capivari</option>
                            <option value="Casa Branca">Casa Branca</option>
                            <option value="Cerqueira César">Cerqueira César</option>
                            <option value="Cerquilho">Cerquilho</option>
                            <option value="Cesário Lange">Cesário Lange</option>
                            <option value="Charqueada">Charqueada</option>
                            <option value="Conchal">Conchal</option>
                            <option value="Conchas">Conchas</option>
                            <option value="Cordeirópolis">Cordeirópolis</option>
                            <option value="Coronel Macedo">Coronel Macedo</option>
                            <option value="Corumbataí">Corumbataí</option>
                            <option value="Cosmópolis">Cosmópolis</option>
                            <option value="Divinolândia">Divinolândia</option>
                            <option value="Elias Fausto">Elias Fausto</option>
                            <option value="Engenheiro Coelho">Engenheiro Coelho</option>
                            <option value="Espírito Santo do Pinhal">Espírito Santo do Pinhal</option>
                            <option value="Estiva Gerbi">Estiva Gerbi</option>
                            <option value="Fartura">Fartura</option>
                            <option value="Guapiara">Guapiara</option>
                            <option value="Guareí">Guareí</option>
                            <option value="Holambra">Holambra</option>
                            <option value="Hortolândia">Hortolândia</option>
                            <option value="Iaras">Iaras</option>
                            <option value="Ibiúna">Ibiúna</option>
                            <option value="Indaiatuba">Indaiatuba</option>
                            <option value="Iperó">Iperó</option>
                            <option value="Ipeúna">Ipeúna</option>
                            <option value="Iracemápolis">Iracemápolis</option>
                            <option value="Itaberá">Itaberá</option>
                            <option value="Itaí">Itaí</option>
                            <option value="Itaoca">Itaoca</option>
                            <option value="Itapetininga">Itapetininga</option>
                            <option value="Itapeva">Itapeva</option>
                            <option value="Itapira">Itapira</option>
                            <option value="Itapirapuã Paulista">Itapirapuã Paulista</option>
                            <option value="Itaporanga">Itaporanga</option>
                            <option value="Itararé">Itararé</option>
                            <option value="Itatiba">Itatiba</option>
                            <option value="Itatinga">Itatinga</option>
                            <option value="Itirapina">Itirapina</option>
                            <option value="Itobi">Itobi</option>
                            <option value="Itu">Itu</option>
                            <option value="Itupeva">Itupeva</option>
                            <option value="Jaguariúna">Jaguariúna</option>
                            <option value="Jarinu">Jarinu</option>
                            <option value="Joanópolis">Joanópolis</option>
                            <option value="Jumirim">Jumirim</option>
                            <option value="Jundiaí">Jundiaí</option>
                            <option value="Laranjal Paulista">Laranjal Paulista</option>
                            <option value="Leme">Leme</option>
                            <option value="Limeira">Limeira</option>
                            <option value="Lindóia">Lindóia</option>
                            <option value="Louveira">Louveira</option>
                            <option value="Mairinque">Mairinque</option>
                            <option value="Manduri">Manduri</option>
                            <option value="Mococa">Mococa</option>
                            <option value="Mogi Guaçu">Mogi Guaçu</option>
                            <option value="Mogi Mirim">Mogi Mirim</option>
                            <option value="Mombuca">Mombuca</option>
                            <option value="Monte Alegre do Sul">Monte Alegre do Sul</option>
                            <option value="Monte Mor">Monte Mor</option>
                            <option value="Morungaba">Morungaba</option>
                            <option value="Nazaré Paulista">Nazaré Paulista</option>
                            <option value="Nova Campina">Nova Campina</option>
                            <option value="Nova Odessa">Nova Odessa</option>
                            <option value="Paranapanema">Paranapanema</option>
                            <option value="Pardinho">Pardinho</option>
                            <option value="Paulínia">Paulínia</option>
                            <option value="Pedra Bela">Pedra Bela</option>
                            <option value="Pedreira">Pedreira</option>
                            <option value="Pereiras">Pereiras</option>
                            <option value="Piedade">Piedade</option>
                            <option value="Pilar do Sul">Pilar do Sul</option>
                            <option value="Pinhalzinho">Pinhalzinho</option>
                            <option value="Piracaia">Piracaia</option>
                            <option value="Piracicaba">Piracicaba</option>
                            <option value="Piraju">Piraju</option>
                            <option value="Pirassununga">Pirassununga</option>
                            <option value="Porangaba">Porangaba</option>
                            <option value="Porto Feliz">Porto Feliz</option>
                            <option value="Pratânia">Pratânia</option>
                            <option value="Quadra">Quadra</option>
                            <option value="Rafard">Rafard</option>
                            <option value="Ribeira">Ribeira</option>
                            <option value="Ribeirão Branco">Ribeirão Branco</option>
                            <option value="Ribeirão Grande">Ribeirão Grande</option>
                            <option value="Rio Claro">Rio Claro</option>
                            <option value="Rio das Pedras">Rio das Pedras</option>
                            <option value="Riversul">Riversul</option>
                            <option value="Saltinho">Saltinho</option>
                            <option value="Salto">Salto</option>
                            <option value="Salto de Pirapora">Salto de Pirapora</option>
                            <option value="Santa Bárbara d'Oeste">Santa Bárbara d'Oeste</option>
                            <option value="Santa Cruz da Conceição">Santa Cruz da Conceição</option>
                            <option value="Santa Cruz das Palmeiras">Santa Cruz das Palmeiras</option>
                            <option value="Santa Gertrudes">Santa Gertrudes</option>
                            <option value="Santa Maria da Serra">Santa Maria da Serra</option>
                            <option value="Santo Antônio de Posse">Santo Antônio de Posse</option>
                            <option value="Santo Antônio do Jardim">Santo Antônio do Jardim</option>
                            <option value="São João da Boa Vista">São João da Boa Vista</option>
                            <option value="São José do Rio Pardo">São José do Rio Pardo</option>
                            <option value="São Manuel">São Manuel</option>
                            <option value="São Miguel Arcanjo">São Miguel Arcanjo</option>
                            <option value="São Pedro">São Pedro</option>
                            <option value="São Roque">São Roque</option>
                            <option value="São Sebastião da Grama">São Sebastião da Grama</option>
                            <option value="Sarapuí">Sarapuí</option>
                            <option value="Sarutaiá">Sarutaiá</option>
                            <option value="Serra Negra">Serra Negra</option>
                            <option value="Socorro">Socorro</option>
                            <option value="Sorocaba">Sorocaba</option>
                            <option value="Sumaré">Sumaré</option>
                            <option value="Taguaí">Taguaí</option>
                            <option value="Tambaú">Tambaú</option>
                            <option value="Tapiraí">Tapiraí</option>
                            <option value="Tapiratiba">Tapiratiba</option>
                            <option value="Taquarituba">Taquarituba</option>
                            <option value="Taquarivaí">Taquarivaí</option>
                            <option value="Tatuí">Tatuí</option>
                            <option value="Tejupá">Tejupá</option>
                            <option value="Tietê">Tietê</option>
                            <option value="Torre de Pedra">Torre de Pedra</option>
                            <option value="Torrinha">Torrinha</option>
                            <option value="Tuiuti">Tuiuti</option>
                            <option value="Valinhos">Valinhos</option>
                            <option value="Vargem">Vargem</option>
                            <option value="Vargem Grande do Sul">Vargem Grande do Sul</option>
                            <option value="Várzea Paulista">Várzea Paulista</option>
                            <option value="Vinhedo">Vinhedo</option>
                            <option value="Votorantim">Votorantim</option>
                        </select>
                    </div>
                    <div class="form-row" style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <div class="form-group" style="flex: 2;">
                            <label for="endereco">G. Endereço:</label>
                            <input type="text" id="endereco" name="endereco" required placeholder="Rua, Número...">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label for="bairro">H. Bairro:</label>
                            <input type="text" id="bairro" name="bairro">
                        </div>

                    </div>

                    <!-- Recursos -->
                    <!-- Recursos -->
                    <div class="section-header"><i class="bi bi-people-fill"></i> Recursos e Pessoal</div>
                    <div class="form-row" style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <div class="form-group" style="flex: 1;">
                            <label for="qtd_viaturas">I. Quantidade de Viaturas:</label>
                            <input type="number" id="qtd_viaturas" name="qtd_viaturas" min="0" required>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label for="qtd_bombeiros">J. Quantidade de Militares:</label>
                            <input type="number" id="qtd_bombeiros" name="qtd_bombeiros" min="0" required>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label for="tempo_resposta">O. Tempo Resposta (min):</label>
                            <input type="number" id="tempo_resposta" name="tempo_resposta" min="0">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>K. Encarregado no Local da Ocorrência:</label>
                        <div style="display: flex; gap: 10px;">
                            <select name="encarregado_posto" style="width: 150px;">
                                <option value="SD PM">SD PM</option>
                                <option value="CB PM">CB PM</option>
                                <option value="3ºSGT PM">3ºSGT PM</option>
                                <option value="2ºSGT PM">2ºSGT PM</option>
                                <option value="1ºSGT PM">1ºSGT PM</option>
                                <option value="SUB TEN PM">SUB TEN PM</option>
                                <option value="2º TEN PM">2º TEN PM</option>
                                <option value="1º TEN PM">1º TEN PM</option>
                                <option value="CAP PM">CAP PM</option>
                                <option value="MAJ PM">MAJ PM</option>
                                <option value="TEN CEL PM">TEN CEL PM</option>
                                <option value="CEL PM">CEL PM</option>
                            </select>
                            <input type="text" name="encarregado_nome" placeholder="Nome / QRA" required
                                style="flex: 1;">
                        </div>
                    </div>

                    <div class="section-header"><i class="bi bi-person-badge-fill"></i> P. Oficiais Presentes</div>
                    <div class="form-group"
                        style="background: #fff; border: 1px solid #e2e8f0; padding: 20px; border-radius: 10px; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
                        <label style="display: block; margin-bottom: 12px; font-weight: 600; color: #374151;">Houve
                            Oficial no Local?</label>

                        <div class="radio-buttons-container" style="margin-bottom: 5px;">
                            <input type="radio" name="oficial_presente_opt" id="sem_oficial" value="nao"
                                class="radio-button-input" checked onchange="toggleOficial(false)">
                            <label for="sem_oficial" class="radio-button-label">
                                <i class="bi bi-x-circle-fill"></i> Não (Sem Oficial)
                            </label>

                            <input type="radio" name="oficial_presente_opt" id="com_oficial" value="sim"
                                class="radio-button-input" onchange="toggleOficial(true)">
                            <label for="com_oficial" class="radio-button-label">
                                <i class="bi bi-check-circle-fill"></i> Sim (Oficial Presente)
                            </label>
                        </div>

                        <div id="oficial-details"
                            style="display: none; border-top: 1px solid #e5e7eb; padding-top: 15px; margin-top: 15px; animation: fadeIn 0.3s ease-in-out;">
                            <label
                                style="display: block; margin-bottom: 8px; font-size: 0.9em; color: #4b5563;">Preencha
                                os dados do oficial:</label>
                            <div style="display: flex; gap: 10px;">
                                <select id="posto_oficial" name="posto_oficial"
                                    style="width: 160px; padding: 10px; border-radius: 6px; border: 1px solid #d1d5db; background-color: #fff;">
                                    <option value="">Selecione...</option>
                                    <option value="2ºTEN PM">2ºTEN PM</option>
                                    <option value="1ºTEN PM">1ºTEN PM</option>
                                    <option value="CAP PM">CAP PM</option>
                                    <option value="MAJ PM">MAJ PM</option>
                                    <option value="TEN CEL PM">TEN CEL PM</option>
                                    <option value="CEL PM">CEL PM</option>
                                </select>
                                <input type="text" id="nome_oficial" name="nome_oficial"
                                    placeholder="Nome de Guerra (Ex: SOUSA)"
                                    style="flex: 1; padding: 10px; border-radius: 6px; border: 1px solid #d1d5db;">
                            </div>
                        </div>
                    </div>

                    <!-- Histórico -->
                    <!-- Histórico -->
                    <div class="section-header"><i class="bi bi-file-text-fill"></i> Histórico da Ocorrência</div>
                    <div class="form-group">
                        <label for="historico_inicial">L. Histórico Inicial (O que motivou o atendimento):</label>
                        <textarea id="historico_inicial" name="historico_inicial" rows="3" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="historico_final">M. Histórico Final (Detalhes, vítimas, desfecho):</label>
                        <textarea id="historico_final" name="historico_final" rows="5" required></textarea>
                    </div>

                    <!-- Transmissão -->
                    <div class="form-group" style="background: #f1f5f9; padding: 15px; border-radius: 8px;">
                        <label>N. Responsável pela Transmissão (Quem está preenchendo):</label>
                        <div style="display: flex; gap: 10px;">
                            <select name="pm_transmissao_posto" style="width: 150px;">
                                <option value="SD PM">SD PM</option>
                                <option value="CB PM">CB PM</option>
                                <option value="3ºSGT PM">3ºSGT PM</option>
                                <option value="2ºSGT PM">2ºSGT PM</option>
                                <option value="1ºSGT PM">1ºSGT PM</option>
                                <option value="SUB TEN PM">SUB TEN PM</option>
                                <option value="2º TEN PM">2º TEN PM</option>
                                <option value="1º TEN PM">1º TEN PM</option>
                                <option value="CAP PM">CAP PM</option>
                                <option value="MAJ PM">MAJ PM</option>
                                <option value="TEN CEL PM">TEN CEL PM</option>
                                <option value="CEL PM">CEL PM</option>
                            </select>
                            <input type="text" name="pm_transmissao_nome" placeholder="Seu Nome / QRA" required
                                style="flex: 1;">
                        </div>
                    </div>

                    <!-- Botões de Ação -->
                    <div class="form-row" style="margin-top: 30px;">
                        <button type="button" id="btnGerarVulto" class="btn-premium-action">
                            <i class="fas fa-file-alt"></i> Pré-visualizar Texto
                        </button>
                    </div>

                    <!-- Área de Resultado (Texto Gerado) -->
                    <div id="resultado-container" style="margin-top: 20px; display: none;">
                        <label style="font-weight: bold; display: block; margin-bottom: 5px;">Texto Gerado para
                            Cópia:</label>
                        <textarea id="texto_final" rows="12"
                            style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-family: monospace; background: #fff;"
                            readonly></textarea>

                        <div style="margin-top: 20px; display: flex; gap: 15px;">
                            <button type="button" class="btn-primary"
                                style="flex: 1; background: #16a34a; display: flex; align-items: center; justify-content: center; gap: 10px; border: none;">
                                <i class="fas fa-copy"></i> Copiar Texto
                            </button>
                            <button type="submit" class="btn-primary"
                                style="flex: 1; background: #1f2937; display: flex; align-items: center; justify-content: center; gap: 10px; border: none;">
                                <i class="fas fa-save"></i> Confirmar e Salvar
                            </button>
                        </div>

                        <div style="margin-top: 20px; border-top: 1px solid #e5e7eb; padding-top: 20px;">
                            <button type="button" class="btn-primary btn-ai-feature"
                                style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 10px;"
                                title="Recurso Premium">
                                <i class="fas fa-magic"></i> Gerar Vulto Aprimorado com IA (Em Breve)
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </main>
    </div>
    <script>
        function toggleTermino() {
            const status = document.getElementById('status').value;
            const group = document.getElementById('termino-group');
            if (status === 'ENCERRADA') {
                group.style.display = 'flex';
                document.getElementById('data_termino').required = true;
                terminoGroup.style.display = 'flex';
                inputs.forEach(i => i.required = true);
            } else {
                terminoGroup.style.display = 'none';
                inputs.forEach(i => {
                    i.required = false;
                    i.value = '';
                });
            }
        }

        function toggleOficial(show) {
            const details = document.getElementById('oficial-details');
            const posto = document.getElementById('posto_oficial');
            const nome = document.getElementById('nome_oficial');

            if (show) {
                details.style.display = 'block';
                posto.required = true;
                nome.required = true;
            } else {
                details.style.display = 'none';
                posto.required = false;
                nome.required = false;
                posto.value = "";
                nome.value = "";
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Setar data atual
            const dataInicio = document.getElementById('data_inicio');
            if (dataInicio) {
                const hoje = new Date();
                const yyyy = hoje.getFullYear();
                const mm = String(hoje.getMonth() + 1).padStart(2, '0');
                const dd = String(hoje.getDate()).padStart(2, '0');
                dataInicio.value = `${yyyy}-${mm}-${dd}`;
            }

            // Carregar OPMs
            fetch('/api/opms')
                .then(r => r.json())
                .then(data => {
                    const select = document.getElementById('opm_id');
                    select.innerHTML = '<option value="">Selecione a Estação...</option>';
                    data.forEach(opm => {
                        const option = document.createElement('option');
                        option.value = opm.id;
                        option.textContent = `${opm.EB} (${opm.GB})`;
                        // Salvar dados estruturados
                        option.setAttribute('data-gb', opm.GB);
                        option.setAttribute('data-sgb', opm.SGB);
                        option.setAttribute('data-eb', opm.EB);
                        select.appendChild(option);
                    });
                });

            // Função para gerar texto padrão no frontend
            function gerarTextoPadrao() {
                const f = document.forms['vulto-form'];

                // Helper para pegar valor
                const getVal = (name) => f[name]?.value || '';

                // Helper para validar datas (YYYY-MM-DD -> DD/MM/YYYY)
                const formatDate = (dateStr) => {
                    if (!dateStr) return '';
                    const [y, m, d] = dateStr.split('-');
                    return `${d}/${m}/${y}`;
                }

                // OPM Texto
                const opmSelect = document.getElementById('opm_id');
                const selectedOption = opmSelect.options[opmSelect.selectedIndex];
                let opmText = '';
                if (selectedOption && selectedOption.value) {
                    const gb = (selectedOption.getAttribute('data-gb') || '').toUpperCase();
                    const sgb = (selectedOption.getAttribute('data-sgb') || '').toUpperCase();
                    const eb = (selectedOption.getAttribute('data-eb') || '').toUpperCase();

                    // Formato solicitado: 15ºGB - 1ºSGB - EB CERRADO
                    // Verifica se precisa adicionar o sufixo SGB se não vier
                    let sgbText = sgb;
                    if (sgb && !sgb.includes('SGB')) {
                        sgbText = `${sgb} SGB`;
                    }

                    opmText = `${gb} - ${sgbText} - EB ${eb}`;
                } else {
                    opmText = opmSelect.options[opmSelect.selectedIndex]?.text || '';
                }

                // Oficiais
                let oficiaisLine = "NÃO HOUVE OFICIAL NO LOCAL";
                const houveOficial = document.querySelector('input[name="oficial_presente_opt"]:checked').value;
                if (houveOficial === 'sim') {
                    const posto = getVal('posto_oficial');
                    const nome = getVal('nome_oficial');
                    oficiaisLine = `${posto} ${nome}`;
                }

                const texto = `SECRETARIA DA SEGURANÇA PÚBLICA
CORPO DE BOMBEIROS MILITAR DO ESTADO DE SÃO PAULO
RELATÓRIO DE OCORRÊNCIA VULTO OU DESTAQUE
${opmText}
A. NÚMERO OCORRÊNCIA: ${getVal('talao_numero')}
B. DATA/HORA DA OCORRÊNCIA: ${formatDate(getVal('data_inicio'))} às ${getVal('hora_inicio')}h.
C. STATUS DA OCORRÊNCIA: ${getVal('status')}
D. TIPO DE OCORRÊNCIA (JUSTIFICATIVA VULTO/DESTAQUE): ${getVal('justificativa_vulto')}
E. NATUREZA DA OCORRÊNCIA: ${getVal('natureza_codigo')}
F. MUNICÍPIO: ${getVal('municipio_nome')}
G. ENDEREÇO: ${getVal('endereco')}
H. BAIRRO:    ${getVal('bairro')}
I. QUANTIDADE DE VIATURAS: ${getVal('qtd_viaturas')}
J. QUANTIDADE DE MILITARES: ${getVal('qtd_bombeiros')}
K. ENCARREGADO NO LOCAL DA OCORRÊNCIA: ${getVal('encarregado_posto')} ${getVal('encarregado_nome')}
L. HISTÓRICO INICIAL: ${getVal('historico_inicial')}
M. HISTÓRICO FINAL: ${getVal('historico_final')}
N. NOME PM TRANSMISSÃO: ${getVal('pm_transmissao_posto')} ${getVal('pm_transmissao_nome')}
O. TEMPO PRIMEIRA VTR NO LOCAL (em minutos): ${getVal('tempo_resposta')}
P. OFICIAIS QUE COMPARECERAM NO LOCAL: ${oficiaisLine}`;

                document.getElementById('texto_final').value = texto;
                document.getElementById('resultado-container').style.display = 'block';

                // Scroll suave até o resultado
                document.getElementById('resultado-container').scrollIntoView({ behavior: 'smooth' });
            }

            // Eventos para os botões
            const btnPadrao = document.getElementById('btnGerarVulto');
            const btnIA = document.querySelectorAll('.form-row button.btn-primary')[1];

            if (btnPadrao) {
                btnPadrao.addEventListener('click', gerarTextoPadrao);
            }

            // Listener novo botão Copiar Texto
            const btnCopy = document.querySelector('button i[class="fas fa-copy"]').parentNode;
            if (btnCopy) {
                btnCopy.addEventListener('click', () => {
                    const txt = document.getElementById('texto_final');
                    txt.select();
                    navigator.clipboard.writeText(txt.value).then(() => {
                        alert('Texto copiado!');
                    });
                });
            }

            // Auto-preencher Responsável pela Transmissão se dados existirem
            // Jinja2 renderiza os valores aqui. Se vazio, fica null/empty.
            const userRank = "{{ profile.rank if profile and profile.rank else '' }}";
            const userWarName = "{{ profile.war_name if profile and profile.war_name else '' }}";

            if (userRank) {
                const rankSelect = document.querySelector('select[name="pm_transmissao_posto"]');
                if (rankSelect) {
                    let val = userRank.trim();
                    // Tentar atribuição direta
                    rankSelect.value = val;

                    // Se não selecionou nada (selectedIndex continuou -1 ou 0 se o primeiro for placeholder), tentar normalizações
                    if (rankSelect.selectedIndex <= 0) {
                        const options = Array.from(rankSelect.options);

                        // 1. Tentar UpperCase
                        let match = options.find(o => o.value.toUpperCase() === val.toUpperCase());

                        // 2. Tentar adicionar " PM" se não tiver
                        if (!match && !val.toUpperCase().includes('PM')) {
                            match = options.find(o => o.value.toUpperCase() === (val.toUpperCase() + " PM"));
                        }

                        // 3. Tentar "SD" se for "SOLDADO", etc (Opcional, mas vamos focar no básico primeiro)

                        if (match) {
                            rankSelect.value = match.value;
                        }
                    }
                }
            }
            if (userWarName) {
                const nameInput = document.querySelector('input[name="pm_transmissao_nome"]');
                if (nameInput) nameInput.value = userWarName;
            }
        });

        document.getElementById('vulto-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Processando...';

            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());


            try {
                const res = await fetch('/api/vulto/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();

                if (result.success) {
                    alert('Vulto registrado com sucesso! \n\nO texto gerado será exibido na próxima tela (simulação).');
                    // Redirecionar ou mostrar resultado
                    window.location.href = '/elaborar-vulto/listar';
                } else {
                    alert('Erro: ' + result.error);
                }
            } catch (err) {
                alert('Erro de conexão.');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-file-text"></i> Gerar e Salvar Vulto';
            }
        });
    </script>
</body>

</html>
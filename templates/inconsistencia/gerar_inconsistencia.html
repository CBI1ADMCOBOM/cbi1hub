<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerar Inconsistência - CBI-1</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        .form-container {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            margin: 0 auto;
        }

        .radio-buttons-container {
            display: flex;
            gap: 15px;
            margin-bottom: 2rem;
        }

        .radio-button-label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 15px 20px;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid #e2e8f0;
            background: #fff;
            transition: all 0.2s;
            flex: 1;
            font-weight: 700;
            color: #64748b;
            text-transform: uppercase;
            font-size: 1.1rem;
        }

        .radio-button-label:hover {
            border-color: #cbd5e1;
            background: #f8fafc;
        }

        .radio-button-input {
            display: none;
        }

        /* OPERACIONAL (Azul) */
        .radio-button-input[value="operacional"]:checked+.radio-button-label {
            border-color: #2563eb;
            background: #eff6ff;
            color: #1d4ed8;
            box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.1);
        }

        /* TÉCNICA (Laranja) */
        .radio-button-input[value="tecnica"]:checked+.radio-button-label {
            border-color: #ea580c;
            background: #fff7ed;
            color: #c2410c;
            box-shadow: 0 4px 6px -1px rgba(234, 88, 12, 0.1);
        }

        .option-group {
            display: none;
        }

        .option-group.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .radio-item {
            margin-bottom: 1rem;
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            transition: all 0.2s;
            cursor: pointer;
        }

        .radio-item:hover {
            border-color: var(--primary-color);
            background: #f8fafc;
        }

        .radio-item label {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            cursor: pointer;
            width: 100%;
        }

        .radio-item input[type="radio"] {
            margin-top: 0.25rem;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>
    <div class="app-container">
        <header class="app-header">
            <div class="header-content">
                <div class="logo">BOMBEIROS CBI-1 <span style="font-weight: 400; font-size: 0.9em; opacity: 0.8;">|
                        Inconsistência</span></div>
                <div class="user-menu">
                    <span style="font-size: 0.9rem; margin-right: 1rem;">{{ user.war_name }}</span>
                    <a href="{{ url_for('gerar_inconsistencia_listar') }}" class="btn-secondary btn-sm"
                        style="margin-right: 0.5rem;">
                        <i class="bi bi-list-ul"></i> Visualizar
                    </a>
                    <a href="{{ url_for('gerar_inconsistencia') }}" class="btn-secondary btn-sm">Voltar</a>
                </div>
            </div>
        </header>

        <main class="app-content">
            <div class="form-container">
                <div style="margin-bottom: 2rem;">
                    <h2 style="font-weight: 700; color: var(--primary-color);">Nova Inconsistência</h2>
                    <p style="color: var(--text-muted);">Preencha os dados abaixo para reportar um problema.</p>
                </div>

                <form id="incForm" onsubmit="handleSubmit(event)">
                    <!-- Toggle Tipo -->
                    <div class="form-group">
                        <label>Tipo de Inconsistência</label>
                        <div class="radio-buttons-container">
                            <input type="radio" id="tipo_operacional" name="tipo" value="operacional"
                                class="radio-button-input" checked onchange="handleTipoChange(this.value)">
                            <label for="tipo_operacional" class="radio-button-label">
                                <i class="bi bi-cone-striped"></i> Operacional
                            </label>

                            <input type="radio" id="tipo_tecnica" name="tipo" value="tecnica" class="radio-button-input"
                                onchange="handleTipoChange(this.value)">
                            <label for="tipo_tecnica" class="radio-button-label">
                                <i class="bi bi-pc-display"></i> Técnica
                            </label>
                        </div>
                    </div>

                    <!-- Campos Básicos -->
                    <div class="grid-2">
                        <div class="form-group">
                            <label>Data da Ocorrência</label>
                            <input type="date" name="data_ocorrencia" id="data_ocorrencia" required
                                class="form-control">
                        </div>
                        <div class="form-group" id="talao-group">
                            <label>Número do Talão</label>
                            <input type="text" name="talao" placeholder="Ex: 1234" class="form-control">
                        </div>
                    </div>

                    <!-- Opções Operacionais -->
                    <div id="group-operacional" class="option-group active">
                        <div class="radio-item">
                            <label>
                                <input type="radio" name="motivo_op" value="SC1">
                                <span>SC1 - Ocorrência gerada pelo 193 com erro, faltando informações ou com informações
                                    diferentes das passadas</span>
                            </label>
                        </div>
                        <div class="radio-item">
                            <label>
                                <input type="radio" name="motivo_op" value="SC2">
                                <span>SC2 - Informação sobre vítima diverge da situação encontrada no local</span>
                            </label>
                        </div>
                        <div class="radio-item">
                            <label>
                                <input type="radio" name="motivo_op" value="SC3">
                                <span>SC3 - Cadastro talão/Empenho de vtr em endereço incorreto</span>
                            </label>
                        </div>
                        <div class="radio-item">
                            <label>
                                <input type="radio" name="motivo_op" value="SC5">
                                <span>SC5 - Empenho de Vtr localizada em Estação/Base mais distante do local da
                                    ocorrência</span>
                            </label>
                        </div>
                        <div class="radio-item">
                            <label>
                                <input type="radio" name="motivo_op" value="SC6">
                                <span>SC6 - Vtr empenhada em ocorrência no sistema, porém sem informação à equipe sobre
                                    o empenho pelo controle</span>
                            </label>
                        </div>
                        <div class="radio-item">
                            <label>
                                <input type="radio" name="motivo_op" value="SC7">
                                <span>SC7 - Empenho de duas equipes ou mais para mesma ocorrência</span>
                            </label>
                        </div>
                        <div class="radio-item">
                            <label>
                                <input type="radio" name="motivo_op" value="SC8">
                                <span>SC8 - VTR empenhada, porém nada encontrado no local</span>
                            </label>
                        </div>
                        <div class="radio-item">
                            <label>
                                <input type="radio" name="motivo_op" value="SC9">
                                <span>SC9 - Empenho de UR concomitante com empenho de equipe do SAMU/Concessionária sem
                                    necessidade</span>
                            </label>
                        </div>
                        <div class="radio-item">
                            <label>
                                <input type="radio" name="motivo_op" value="SC10">
                                <span>SC10 - Empenho desnecessário de VTR</span>
                            </label>
                        </div>
                        <div class="radio-item">
                            <label>
                                <input type="radio" name="motivo_op" value="SC11">
                                <span>SC11 - Empenho de vtr para ocorrência não emergencial ou empenho equivocado de
                                    equipe em ocorrência</span>
                            </label>
                        </div>
                        <div class="radio-item">
                            <label>
                                <input type="radio" name="motivo_op" value="SC12">
                                <span>SC12 - Demora para empenhar vtr após a geração do talão</span>
                            </label>
                        </div>
                        <div class="radio-item">
                            <label>
                                <input type="radio" name="motivo_op" value="SC14">
                                <span>SC14 - Falta de empenho de viatura que deveria ser empenhada</span>
                            </label>
                        </div>
                    </div>

                    <!-- Opções Técnicas -->
                    <div id="group-tecnica" class="option-group">
                        <div class="radio-item">
                            <label>
                                <input type="radio" name="motivo_tec" value="T1" onchange="toggleSubForm(this)">
                                <span>T1 - Sem comunicação via Rádio: Sem Contato, Dificuldade de comunicação</span>
                            </label>
                        </div>

                        <div class="radio-item">
                            <label>
                                <input type="radio" name="motivo_tec" value="T2" onchange="toggleSubForm(this)">
                                <span>T2 - Sem comunicação via ZELLO: Sem conexão, volume baixo, sem som</span>
                            </label>
                        </div>

                        <div class="radio-item">
                            <label>
                                <input type="radio" name="motivo_tec" value="T3" onchange="toggleSubForm(this)">
                                <span>T3 - Sem comunicação via telefone: Não atende, Não completa ligação</span>
                            </label>
                        </div>

                        <div class="radio-item">
                            <label>
                                <input type="radio" name="motivo_tec" value="T4_193" onchange="toggleSubForm(this)">
                                <span>T4 - Problemas no 193: Falhas na linha 193</span>
                            </label>
                            <!-- Sub-formulário para T4-193 -->
                            <div id="sub-T4_193" class="sub-form">
                                <div class="grid-2">
                                    <div class="form-group">
                                        <label>Origem</label>
                                        <select name="t4_origem" class="form-control">
                                            <option value="">Selecione...</option>
                                            <option value="FIXO">Fixo</option>
                                            <option value="MOVEL">Móvel</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Operadora</label>
                                        <select name="t4_operadora" class="form-control">
                                            <option value="">Selecione...</option>
                                            <option value="VIVO">Vivo</option>
                                            <option value="CLARO">Claro</option>
                                            <option value="OI">Oi</option>
                                            <option value="TIM">Tim</option>
                                            <option value="OUTRA">Outra</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="grid-2">
                                    <div class="form-group">
                                        <label>Número que tentou ligar</label>
                                        <input type="tel" name="t4_numero" class="form-control">
                                    </div>
                                    <div class="form-group">
                                        <label>Data e Horário</label>
                                        <input type="datetime-local" name="t4_datahora" class="form-control">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Tipo de Falha</label>
                                    <select name="t4_falha" class="form-control">
                                        <option value="">Selecione...</option>
                                        <option value="NAO_CHAMA">Não Chama</option>
                                        <option value="CAI_OUTRO_LUGAR">Cai em outro lugar</option>
                                        <option value="MUDO">Mudo</option>
                                        <option value="OUTRO">Outro</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="radio-item">
                            <label>
                                <input type="radio" name="motivo_tec" value="T4_APP" onchange="toggleSubForm(this)">
                                <span>T5 - Aplicativo CBI-1: Falhas nos sistemas internos</span>
                            </label>
                            <!-- Sub-formulário para T4-APP -->
                            <div id="sub-T4_APP" class="sub-form">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Sistema
                                    Afetado:</label>
                                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                                    <label><input type="radio" name="t4_sistema" value="VULTO"> Vulto</label>
                                    <label><input type="radio" name="t4_sistema" value="RAIA"> R.A.I.A</label>
                                    <label><input type="radio" name="t4_sistema" value="MERGULHO"> Mergulho</label>
                                    <label><input type="radio" name="t4_sistema" value="FOGO"> Apoio Fogo</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group" style="margin-top: 1.5rem;">
                        <label>Observações</label>
                        <textarea name="observacao" rows="4" class="form-control"
                            placeholder="Detalhes adicionais..."></textarea>
                    </div>

                    <div class="form-actions"
                        style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 2rem;">
                        <a href="{{ url_for('gerar_inconsistencia') }}" class="btn-secondary">Cancelar</a>
                        <button type="submit" class="btn-primary">Gerar Relatório</button>
                    </div>
                </form>
            </div>
        </main>
    </div>

    <script>
        // Inicializar data atual
        document.getElementById('data_ocorrencia').valueAsDate = new Date();

        function handleTipoChange(tipo) {
            // Atualizar visibilidade dos grupos
            document.getElementById('group-operacional').className = `option-group ${tipo === 'operacional' ? 'active' : ''}`;
            document.getElementById('group-tecnica').className = `option-group ${tipo === 'tecnica' ? 'active' : ''}`;

            // Atualizar visibilidade do Talão
            const talaoGroup = document.getElementById('talao-group');
            if (tipo === 'operacional') {
                talaoGroup.style.display = 'block';
            } else {
                talaoGroup.style.display = 'none';
            }
        }

        function toggleSubForm(radio) {
            // Esconder todos os sub-forms primeiro dentro do contexto
            document.querySelectorAll('.sub-form').forEach(el => el.style.display = 'none');

            // Mostrar o sub-form associado se houver
            const subForm = document.getElementById(`sub-${radio.value}`);
            if (subForm) {
                subForm.style.display = 'block';
            }
        }

        async function handleSubmit(e) {
            e.preventDefault();

            const form = e.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            // Capturar a descrição do motivo selecionado
            let descricao = '';
            if (data.tipo === 'operacional') {
                const selectedRadio = form.querySelector('input[name="motivo_op"]:checked');
                if (selectedRadio) {
                    descricao = selectedRadio.nextElementSibling.textContent.trim();
                }
            } else {
                const selectedRadio = form.querySelector('input[name="motivo_tec"]:checked');
                if (selectedRadio) {
                    descricao = selectedRadio.nextElementSibling.textContent.trim();
                }
            }
            data.motivo_descricao = descricao;

            // Tratamento de campos vazios e validação básica se necessário
            const btn = form.querySelector('button[type="submit"]');
            const originalText = btn.textContent;
            btn.textContent = 'Enviando...';
            btn.disabled = true;

            try {
                const response = await fetch('/api/inconsistencias/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    alert('Inconsistência registrada com sucesso!');
                    window.location.href = "{{ url_for('gerar_inconsistencia_listar') }}";
                } else {
                    alert('Erro ao salvar: ' + (result.error || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro de conexão ao salvar.');
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }
    </script>
</body>

</html>